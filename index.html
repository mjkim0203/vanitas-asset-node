<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>3D Workspace with Auction</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        #container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        /* CSS3D 렌더러가 이 위에 올라옵니다 */
    </style>
</head>
<body>
    <div id="container"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';

        // 1. 씬 & 카메라 설정
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a); // 어두운 배경

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 15, 20); // 초기 카메라 위치 (적절히 조절 필요)

        // 2. 렌더러 설정 (두 개를 겹침)
        const container = document.getElementById('container');

        // (1) WebGL Renderer (3D 모델용)
        const webglRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        webglRenderer.setSize(window.innerWidth, window.innerHeight);
        webglRenderer.domElement.style.position = 'absolute';
        webglRenderer.domElement.style.top = 0;
        webglRenderer.domElement.style.zIndex = 0; 
        container.appendChild(webglRenderer.domElement);

        // (2) CSS3D Renderer (웹사이트 화면용)
        const cssRenderer = new CSS3DRenderer();
        cssRenderer.setSize(window.innerWidth, window.innerHeight);
        cssRenderer.domElement.style.position = 'absolute';
        cssRenderer.domElement.style.top = 0;
        cssRenderer.domElement.style.zIndex = 1; // 클릭 가능하도록 위에 배치
        container.appendChild(cssRenderer.domElement);

        // 3. 조명 설정
        const ambientLight = new THREE.AmbientLight(0xffffff, 1);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        // 4. 컨트롤 설정
        const controls = new OrbitControls(camera, cssRenderer.domElement);
        controls.enableDamping = true;

        // 5. 모델 로드 및 화면 부착
        const loader = new GLTFLoader();
        
        loader.load('room.glb', (gltf) => {
            const model = gltf.scene;
            scene.add(model);

            // ★ 핵심: Blender에서 만든 'imacscreen' 오브젝트 찾기
            const screenMesh = model.getObjectByName('imacscreen');

            if (screenMesh) {
                console.log("iMac 화면을 찾았습니다!", screenMesh);

                // 1) iframe 요소 생성 (경매 사이트 불러오기)
                const div = document.createElement('div');
                div.style.width = '1000px';  // 웹사이트 해상도 (가로)
                div.style.height = '700px';  // 웹사이트 해상도 (세로)
                div.style.backgroundColor = 'white';

                const iframe = document.createElement('iframe');
                iframe.src = 'auction.html'; // ★ 저장한 경매 사이트 파일
                iframe.style.width = '1000px';
                iframe.style.height = '700px';
                iframe.style.border = 'none';
                div.appendChild(iframe);

                // 2) CSS3D 오브젝트로 변환
                const cssObject = new CSS3DObject(div);

                // 3) 3D 모델(imacscreen)의 위치/회전/크기 복사
                // (부모가 있을 경우 월드 좌표를 가져와야 정확함)
                cssObject.position.copy(screenMesh.getWorldPosition(new THREE.Vector3()));
                cssObject.quaternion.copy(screenMesh.getWorldQuaternion(new THREE.Quaternion()));
                
                // 4) 크기 맞추기 (HTML 픽셀 크기 -> 3D 미터 단위로 축소)
                // Blender의 스크린 크기에 따라 이 값을 조절해야 합니다.
                // 보통 0.001 ~ 0.005 사이 값을 곱해서 맞춥니다.
                const scaleFactor = 0.001; 
                cssObject.scale.set(scaleFactor, scaleFactor, scaleFactor);

                // 5) 기존 검은 화면은 숨기기 (안 보이게 처리)
                // screenMesh.visible = false; 
                // 혹은 검은 화면보다 아주 살짝 앞으로 튀어나오게 설정
                cssObject.translateZ(0.01); 

                scene.add(cssObject);

                // 6) 카메라가 화면을 잘 보이게 이동 (선택사항)
                // controls.target.copy(cssObject.position);

            } else {
                console.error("경고: 'imacscreen'이라는 이름의 오브젝트를 찾을 수 없습니다.");
            }

        }, undefined, (error) => {
            console.error('모델 로드 에러:', error);
        });

        // 6. 애니메이션 루프
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            webglRenderer.render(scene, camera);
            cssRenderer.render(scene, camera);
        }
        animate();

        // 리사이즈 대응
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            webglRenderer.setSize(window.innerWidth, window.innerHeight);
            cssRenderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>

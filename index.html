<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Vanitas 3D Workspace</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #333; }
        #container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* ÎÇòÍ∞ÄÍ∏∞ Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        #back-btn {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            padding: 12px 30px; background: white; color: black; 
            border: none; border-radius: 30px; font-weight: bold; cursor: pointer;
            opacity: 0; pointer-events: none; transition: opacity 0.5s; z-index: 100;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-family: sans-serif; text-transform: uppercase; letter-spacing: 1px;
        }
        #back-btn:hover { background: #f0f0f0; transform: translateX(-50%) scale(1.05); }
        #back-btn.active { opacity: 1; pointer-events: auto; }

        /* ÏïàÎÇ¥ Î¨∏Íµ¨ */
        #guide {
            position: absolute; top: 30px; width: 100%; text-align: center;
            color: rgba(255, 255, 255, 0.7); pointer-events: none; z-index: 10; 
            font-family: sans-serif; letter-spacing: 1px; font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div id="guide">LOADING 3D ROOM...</div>
    <div id="container"></div>
    <button id="back-btn">EXIT MONITOR</button>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "tween": "https://unpkg.com/@tweenjs/tween.js@23.1.1/dist/tween.esm.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';
        import * as TWEEN from 'tween';

        // -------------------------------------------------------------------------
        // 1. Í∏∞Î≥∏ ÏÑ§Ï†ï (Ïî¨, Ïπ¥Î©îÎùº, Î†åÎçîÎü¨)
        // -------------------------------------------------------------------------
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x555555); // Î∞∞Í≤ΩÏÉâ (ÌïÑÏöîÏãú Î≥ÄÍ≤Ω)

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 5000);
        
        // Î†åÎçîÎü¨ Ïª®ÌÖåÏù¥ÎÑà
        const container = document.getElementById('container');

        // [A] WebGL Renderer (3D Î™®Îç∏Ïö©, Í≥†ÌôîÏßà ÏÑ§Ï†ï)
        const webglRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        webglRenderer.setPixelRatio(window.devicePixelRatio); 
        webglRenderer.setSize(window.innerWidth, window.innerHeight);
        webglRenderer.outputColorSpace = THREE.SRGBColorSpace; 
        webglRenderer.domElement.style.position = 'absolute';
        webglRenderer.domElement.style.zIndex = 0; 
        container.appendChild(webglRenderer.domElement);

        // [B] CSS3D Renderer (ÏõπÏÇ¨Ïù¥Ìä∏ ÌôîÎ©¥Ïö©)
        const cssRenderer = new CSS3DRenderer();
        cssRenderer.setSize(window.innerWidth, window.innerHeight);
        cssRenderer.domElement.style.position = 'absolute';
        cssRenderer.domElement.style.zIndex = 1; 
        cssRenderer.domElement.style.pointerEvents = 'none'; // ÌèâÏÜåÏóî ÌÅ¥Î¶≠ ÌÜµÍ≥º
        container.appendChild(cssRenderer.domElement);

        // Ï°∞Î™Ö ÏÑ§Ï†ï
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.2);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(5, 10, 5);
        scene.add(dirLight);

        // Ïª®Ìä∏Î°§ ÏÑ§Ï†ï (WebGL Î†åÎçîÎü¨Ïóê Ïó∞Í≤∞Ìï¥Ïïº ÌöåÏ†Ñ Í∞ÄÎä•)
        const controls = new OrbitControls(camera, webglRenderer.domElement); 
        controls.enableDamping = true;
        controls.minDistance = 0.5;
        controls.maxDistance = 10;

        // -------------------------------------------------------------------------
        // 2. Î≥ÄÏàò Î∞è ÏÉÅÌÉú Í¥ÄÎ¶¨
        // -------------------------------------------------------------------------
        const loader = new GLTFLoader();
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        let screenMesh = null;
        let isZoomed = false;
        
        // 'Ìôà(Home)' ÏúÑÏπò Ï†ÄÏû•Ïö© (Ï±ÖÏÉÅ Î∑∞)
        let homeTarget = new THREE.Vector3(); 
        let homeCamPos = new THREE.Vector3();

        // -------------------------------------------------------------------------
        // 3. Î™®Îç∏ Î°úÎìú (room.glb)
        // -------------------------------------------------------------------------
        loader.load('room.glb', (gltf) => {
            const model = gltf.scene;
            scene.add(model);
            
            document.getElementById('guide').innerText = "DRAG TO ROTATE / CLICK MONITOR TO ENTER";

            // [Î™®Îç∏ Ï§ëÏïô Ï†ïÎ†¨] (0,0,0)ÏúºÎ°ú Ïù¥Îèô
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            model.position.sub(center); 

            // 'imacscreen' Ïò§Î∏åÏ†ùÌä∏ Ï∞æÍ∏∞
            screenMesh = model.getObjectByName('imacscreen');
            
            if (screenMesh) {
                console.log("‚úÖ iMac ÌôîÎ©¥ Î∞úÍ≤¨!");
                addWebScreen(screenMesh);

                // --- [Ï¥àÍ∏∞ ÏãúÏ†ê ÏÑ§Ï†ï: Ï±ÖÏÉÅ Î∑∞] ---
                const screenPos = new THREE.Vector3();
                screenMesh.getWorldPosition(screenPos);
                
                // 1) ÌöåÏ†Ñ Ï§ëÏã¨(Target): Î™®ÎãàÌÑ∞ ÏúÑÏπòÎ≥¥Îã§ ÏÇ¥Ïßù ÏïÑÎûò (Ï±ÖÏÉÅ ÎÜíÏù¥)
                homeTarget.copy(screenPos);
                homeTarget.y -= 0.3; 
                controls.target.copy(homeTarget);

                // 2) Ïπ¥Î©îÎùº ÏúÑÏπò: Ï±ÖÏÉÅ Ï†ïÎ©¥ (x=0, y=1.2, z=3.0)
                // ‚òÖ Ïù¥ Ïà´ÏûêÎ•º Ï°∞Ï†àÌïòÎ©¥ Ï≤òÏùå Î≥¥Ïù¥Îäî Í±∞Î¶¨Í∞Ä Îã¨ÎùºÏßëÎãàÎã§.
                homeCamPos.set(0, 1.2, 3.0); 
                camera.position.copy(homeCamPos);
                camera.lookAt(homeTarget);
                
            } else {
                console.error("üö® 'imacscreen' Ïò§Î∏åÏ†ùÌä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
                // ÎπÑÏÉÅÏö© Í∏∞Î≥∏Í∞í
                camera.position.set(0, 2, 5);
            }

        }, undefined, (error) => {
            console.error('Î™®Îç∏ Î°úÎìú Ïã§Ìå®:', error);
            document.getElementById('guide').innerText = "MODEL LOAD ERROR";
        });

        // -------------------------------------------------------------------------
        // 4. ÏõπÏÇ¨Ïù¥Ìä∏ ÌôîÎ©¥ ÏÉùÏÑ± Ìï®Ïàò (addWebScreen)
        // -------------------------------------------------------------------------
        function addWebScreen(mesh) {
            // [ÌôîÏßà Í∞úÏÑ†] 2Î∞∞ Ìï¥ÏÉÅÎèÑ ÌÖçÏä§Ï≤ò (2000x1400)
            const width = 2000;  
            const height = 1400; 

            const div = document.createElement('div');
            div.style.width = width + 'px'; 
            div.style.height = height + 'px'; 
            div.style.backgroundColor = 'white'; // Î°úÎî© Ï§ë Ìù∞ÏÉâ Î∞∞Í≤Ω

            const iframe = document.createElement('iframe');
            iframe.src = 'auction.html'; // ‚òÖ Í≤ΩÎß§ ÏõπÏÇ¨Ïù¥Ìä∏ ÌååÏùº
            iframe.style.width = width + 'px';
            iframe.style.height = height + 'px';
            iframe.style.border = 'none';
            iframe.style.pointerEvents = 'auto'; // ÎÇ¥Î∂Ä ÌÅ¥Î¶≠ ÌóàÏö©
            div.appendChild(iframe);

            const cssObject = new CSS3DObject(div);
            
            // ÏúÑÏπòÏôÄ ÌöåÏ†ÑÍ∞í Í∞ÄÏ†∏Ïò§Í∏∞
            const worldPos = new THREE.Vector3();
            const worldQuat = new THREE.Quaternion();
            mesh.getWorldPosition(worldPos);
            mesh.getWorldQuaternion(worldQuat);

            // 1) ÏúÑÏπò/ÌöåÏ†Ñ Î≥µÏÇ¨
            cssObject.position.copy(worldPos);
            cssObject.quaternion.copy(worldQuat);
            
            // 2) Ïä§ÏºÄÏùº: Ìï¥ÏÉÅÎèÑÎ•º 2Î∞∞ ÌÇ§Ïõ†ÏúºÎØÄÎ°ú Ïä§ÏºÄÏùºÏùÄ Ï†àÎ∞ò(0.0005)
            cssObject.scale.set(0.0005, 0.0005, 0.0005);

            // 3) ‚òÖ [ÌöåÏ†Ñ Î≥¥Ï†ï] ÌôîÎ©¥ ÏÑ∏Ïö∞Í∏∞ + Îí§ÏßëÌûò Î∞©ÏßÄ ‚òÖ
            cssObject.rotateX(-Math.PI / 2); // 90ÎèÑ ÏùºÏúºÏºú ÏÑ∏Ïö∞Í∏∞
            cssObject.rotateZ(Math.PI);      // 180ÎèÑ ÎèåÎ†§ÏÑú Î∞îÎ°úÏû°Í∏∞

            // 4) Í≤πÏπ® Î∞©ÏßÄ (ÏÇ¥Ïßù ÏïûÏúºÎ°ú)
            cssObject.translateZ(0.02);

            scene.add(cssObject);
        }

        // -------------------------------------------------------------------------
        // 5. ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (Ï§åÏù∏ Î°úÏßÅ)
        // -------------------------------------------------------------------------
        window.addEventListener('click', onMouseClick);

        function onMouseClick(event) {
            if (isZoomed || !screenMesh) return;

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);

            if (intersects.length > 0) {
                const obj = intersects[0].object;
                // Î™®ÎãàÌÑ∞Î•º ÌÅ¥Î¶≠ÌïòÎ©¥ Ï§åÏù∏
                if (obj.name === 'imacscreen' || obj === screenMesh) {
                    zoomIn(screenMesh);
                }
            }
        }

        function zoomIn(targetMesh) {
            isZoomed = true;
            controls.enabled = false; // ÌöåÏ†Ñ Ïû†Í∏à

            // ÌÉÄÍ≤ü ÏúÑÏπò Ï†ïÎ≥¥
            const targetPos = new THREE.Vector3();
            const targetQuat = new THREE.Quaternion();
            targetMesh.getWorldPosition(targetPos);
            targetMesh.getWorldQuaternion(targetQuat);

            // ‚òÖ [Ï†ïÎ©¥ Î≤°ÌÑ∞ Í≥ÑÏÇ∞] ÌôîÎ©¥Ïù¥ Î∞îÎùºÎ≥¥Îäî 'ÏïûÎ∞©Ìñ•' Í≥ÑÏÇ∞
            const direction = new THREE.Vector3(0, 0, 1);
            direction.applyQuaternion(targetQuat);
            direction.normalize();

            // Î™©Ìëú Ïπ¥Î©îÎùº ÏúÑÏπò: Ï†ïÎ©¥ Î∞©Ìñ•ÏúºÎ°ú distanceÎßåÌÅº Îñ®Ïñ¥ÏßÑ Í≥≥
            const distance = 0.6; // Ï§åÏù∏ Í±∞Î¶¨ (Ïà´ÏûêÍ∞Ä ÏûëÏùÑÏàòÎ°ù ÌôîÎ©¥ ÍΩâ Ï∞∏)
            const camTargetPos = targetPos.clone().add(direction.multiplyScalar(distance));

            // Ïπ¥Î©îÎùº Ïù¥Îèô Ïï†ÎãàÎ©îÏù¥ÏÖò
            new TWEEN.Tween(camera.position)
                .to({ x: camTargetPos.x, y: camTargetPos.y, z: camTargetPos.z }, 1500)
                .easing(TWEEN.Easing.Cubic.InOut)
                .start();

            // ÏãúÏÑ† Ïù¥Îèô Ïï†ÎãàÎ©îÏù¥ÏÖò
            new TWEEN.Tween(controls.target)
                .to({ x: targetPos.x, y: targetPos.y, z: targetPos.z }, 1500)
                .easing(TWEEN.Easing.Cubic.InOut)
                .onComplete(() => {
                    // ÏôÑÎ£å ÌõÑ: ÏõπÏÇ¨Ïù¥Ìä∏ Ï°∞Ïûë ÌóàÏö©
                    cssRenderer.domElement.style.pointerEvents = 'auto';
                    document.getElementById('back-btn').classList.add('active');
                    document.getElementById('guide').style.opacity = '0';
                })
                .start();
        }

        // -------------------------------------------------------------------------
        // 6. ÎÇòÍ∞ÄÍ∏∞ Î≤ÑÌäº (Ï§åÏïÑÏõÉ Î°úÏßÅ)
        // -------------------------------------------------------------------------
        document.getElementById('back-btn').addEventListener('click', () => {
            isZoomed = false;
            cssRenderer.domElement.style.pointerEvents = 'none'; // Îã§Ïãú ÌÅ¥Î¶≠ Ï∞®Îã®
            document.getElementById('back-btn').classList.remove('active');
            document.getElementById('guide').style.opacity = '1';

            // ÏõêÎûò ÏúÑÏπò(Ï±ÖÏÉÅ Î∑∞)Î°ú Î≥µÍ∑Ä
            new TWEEN.Tween(camera.position)
                .to(homeCamPos, 1500)
                .easing(TWEEN.Easing.Cubic.InOut)
                .start();

            // ÏõêÎûò ÌÉÄÍ≤üÏúºÎ°ú Î≥µÍ∑Ä
            new TWEEN.Tween(controls.target)
                .to(homeTarget, 1500)
                .easing(TWEEN.Easing.Cubic.InOut)
                .onComplete(() => {
                    controls.enabled = true; // ÌöåÏ†Ñ Îã§Ïãú ÌóàÏö©
                })
                .start();
        });

        // Ïï†ÎãàÎ©îÏù¥ÏÖò Î£®ÌîÑ
        function animate() {
            requestAnimationFrame(animate);
            TWEEN.update();
            controls.update();
            webglRenderer.render(scene, camera);
            cssRenderer.render(scene, camera);
        }
        animate();

        // Î¶¨ÏÇ¨Ïù¥Ï¶à ÎåÄÏùë
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            webglRenderer.setPixelRatio(window.devicePixelRatio);
            webglRenderer.setSize(window.innerWidth, window.innerHeight);
            cssRenderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>

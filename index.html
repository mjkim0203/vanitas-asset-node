<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blender Boots Viewer</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #222; color: white; font-family: sans-serif; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 1.2rem; pointer-events: none; transition: opacity 0.5s;
        }

        #back-btn {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            padding: 10px 25px; background: white; color: black; border: none; border-radius: 20px;
            font-weight: bold; cursor: pointer; opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        #back-btn.active { opacity: 1; pointer-events: auto; }

        /* 안내 문구 */
        #guide {
            position: absolute; top: 20px; width: 100%; text-align: center;
            color: #aaa; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="loader">LOADING BOOTS...</div>
    <div id="guide">CLICK THE BOOTS TO INSPECT</div>
    <button id="back-btn">RESET VIEW</button>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "tween": "https://unpkg.com/@tweenjs/tween.js@23.1.1/dist/tween.esm.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import * as TWEEN from 'tween';

        // 1. 씬 설정
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222); // 부츠가 잘 보이도록 어두운 회색 배경

        // 카메라 설정 (부츠는 작으므로 좀 더 가까이)
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
        const initialCameraPosition = { x: 3, y: 2, z: 3 }; // 초기 위치
        const initialTarget = { x: 0, y: 0, z: 0 };
        camera.position.set(initialCameraPosition.x, initialCameraPosition.y, initialCameraPosition.z);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true; // 그림자 활성화
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        document.body.appendChild(renderer.domElement);

        // 2. 조명 설정 (부츠의 질감을 살리기 위한 3점 조명)
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4); // 전체적으로 은은하게
        scene.add(ambientLight);

        // 주광원 (Key Light)
        const mainLight = new THREE.DirectionalLight(0xffffff, 1.5);
        mainLight.position.set(5, 5, 5);
        mainLight.castShadow = true;
        scene.add(mainLight);

        // 보조광원 (Fill Light) - 반대편 그림자 완화
        const fillLight = new THREE.DirectionalLight(0xffffff, 0.8);
        fillLight.position.set(-5, 2, -5);
        scene.add(fillLight);

        // 3. 컨트롤 설정
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.target.set(initialTarget.x, initialTarget.y, initialTarget.z);

        // 4. 모델 로드 (boots.glb)
        const loader = new GLTFLoader();
        let model;

        loader.load('boots.glb', (gltf) => {  // ★ 변환한 파일명 입력
            model = gltf.scene;
            scene.add(model);

            model.traverse((child) => {
                if (child.isMesh) {
                    child.castShadow = true;
                    child.receiveShadow = true;
                }
            });

            // 로딩 완료 처리
            document.getElementById('loader').style.opacity = 0;
            
            // 모델 중앙 정렬 및 크기 자동 조정
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());

            // 모델을 원점으로 이동
            model.position.sub(center); 

            // 너무 크거나 작으면 적당한 크기로 스케일 조정 (높이 1 기준)
            const maxDim = Math.max(size.x, size.y, size.z);
            if (maxDim > 0) {
                const scale = 1.5 / maxDim; // 1.5 크기로 맞춤
                model.scale.multiplyScalar(scale);
            }

        }, undefined, (error) => {
            console.error('모델 로드 실패:', error);
            document.getElementById('loader').innerText = "파일을 찾을 수 없습니다 (boots.glb 확인 필요)";
        });

        // 5. 인터랙션 (클릭 시 확대)
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let isZoomed = false;

        window.addEventListener('click', onMouseClick);

        function onMouseClick(event) {
            if (isZoomed) return;

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);

            if (intersects.length > 0) {
                // 부츠의 어느 부분을 클릭하든 부츠 전체를 자세히 보도록 설정
                // 클릭한 지점(targetPoint)을 중심으로 줌인
                const targetPoint = intersects[0].point;
                const offset = 1.2; // 줌인 거리 (더 가까이)

                // 카메라가 현재 바라보는 방향 유지하며 다가가기
                const direction = new THREE.Vector3().subVectors(camera.position, targetPoint).normalize();
                const newCamPos = new THREE.Vector3().copy(targetPoint).add(direction.multiplyScalar(offset));

                zoomToView(newCamPos, targetPoint);
            }
        }

        function zoomToView(newCamPos, newTarget) {
            isZoomed = true;
            controls.enabled = false;

            // 카메라 이동
            new TWEEN.Tween(camera.position)
                .to({ x: newCamPos.x, y: newCamPos.y, z: newCamPos.z }, 1200)
                .easing(TWEEN.Easing.Cubic.InOut)
                .start();

            // 타겟 이동
            new TWEEN.Tween(controls.target)
                .to({ x: newTarget.x, y: newTarget.y, z: newTarget.z }, 1200)
                .easing(TWEEN.Easing.Cubic.InOut)
                .onComplete(() => {
                    document.getElementById('back-btn').classList.add('active');
                })
                .start();
        }

        // 6. 리셋 버튼
        document.getElementById('back-btn').addEventListener('click', () => {
            isZoomed = false;
            document.getElementById('back-btn').classList.remove('active');

            new TWEEN.Tween(camera.position)
                .to({ x: initialCameraPosition.x, y: initialCameraPosition.y, z: initialCameraPosition.z }, 1200)
                .easing(TWEEN.Easing.Cubic.InOut)
                .start();

            new TWEEN.Tween(controls.target)
                .to({ x: initialTarget.x, y: initialTarget.y, z: initialTarget.z }, 1200)
                .easing(TWEEN.Easing.Cubic.InOut)
                .onComplete(() => {
                    controls.enabled = true;
                })
                .start();
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        function animate() {
            requestAnimationFrame(animate);
            TWEEN.update();
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

    </script>
</body>
</html>

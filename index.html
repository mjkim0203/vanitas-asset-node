<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Position Fixer Mode</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #333; }
        #container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #guide {
            position: absolute; top: 10px; left: 10px; 
            color: yellow; font-family: sans-serif; font-weight: bold; 
            background: rgba(0,0,0,0.7); padding: 10px; z-index: 100; pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="guide">
        우측 상단 컨트롤러를 움직여서 화면을 맞춰주세요.<br>
        완료되면 F12(콘솔)에 나온 값을 복사해서 쓰면 됩니다.
    </div>
    <div id="container"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "lil-gui": "https://unpkg.com/three@0.160.0/examples/jsm/libs/lil-gui.module.min.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';
        import { GUI } from 'lil-gui'; // ★ 컨트롤러 라이브러리

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x333333);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 5000);
        camera.position.set(0, 2, 5); // 잘 보이는 위치

        const container = document.getElementById('container');

        // WebGL
        const webglRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        webglRenderer.setSize(window.innerWidth, window.innerHeight);
        webglRenderer.domElement.style.position = 'absolute';
        webglRenderer.domElement.style.zIndex = 0; 
        container.appendChild(webglRenderer.domElement);

        // CSS3D
        const cssRenderer = new CSS3DRenderer();
        cssRenderer.setSize(window.innerWidth, window.innerHeight);
        cssRenderer.domElement.style.position = 'absolute';
        cssRenderer.domElement.style.zIndex = 1; 
        // 조절 중에는 클릭 방해 안 받게 none
        cssRenderer.domElement.style.pointerEvents = 'none'; 
        container.appendChild(cssRenderer.domElement);

        // 조명
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(5, 10, 5);
        scene.add(dirLight);

        // 컨트롤
        const controls = new OrbitControls(camera, webglRenderer.domElement); 
        controls.enableDamping = true;

        // 로더
        const loader = new GLTFLoader();
        
        loader.load('room.glb', (gltf) => {
            const model = gltf.scene;
            scene.add(model);
            
            // 모델 중앙 정렬
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            model.position.sub(center); 

            const screenMesh = model.getObjectByName('imacscreen');
            
            if (screenMesh) {
                console.log("화면 발견! 컨트롤러를 켭니다.");
                
                // 카메라가 모니터를 바로 보게 이동
                const screenPos = new THREE.Vector3();
                screenMesh.getWorldPosition(screenPos);
                controls.target.copy(screenPos);
                camera.position.set(screenPos.x, screenPos.y + 1, screenPos.z + 3);
                camera.lookAt(screenPos);

                // 웹 화면 추가 및 컨트롤러 연결
                addWebScreenWithGUI(screenMesh);
            } else {
                alert("'imacscreen'을 못 찾았습니다. 모델 이름을 다시 확인해주세요.");
            }
        });

        function addWebScreenWithGUI(mesh) {
            const width = 1000;  
            const height = 700; 

            const div = document.createElement('div');
            div.style.width = width + 'px'; 
            div.style.height = height + 'px'; 
            div.style.backgroundColor = 'rgba(255, 0, 0, 0.5)'; // 잘 보이게 빨간 반투명

            const iframe = document.createElement('iframe');
            iframe.src = 'auction.html';
            iframe.style.width = width + 'px';
            iframe.style.height = height + 'px';
            iframe.style.border = '2px solid yellow'; // 테두리 표시
            div.appendChild(iframe);

            const cssObject = new CSS3DObject(div);
            
            // 1. 일단 모델 위치로 이동
            const worldPos = new THREE.Vector3();
            const worldQuat = new THREE.Quaternion();
            mesh.getWorldPosition(worldPos);
            mesh.getWorldQuaternion(worldQuat);

            cssObject.position.copy(worldPos);
            cssObject.quaternion.copy(worldQuat);
            
            // 기본 스케일
            cssObject.scale.set(0.001, 0.001, 0.001);
            scene.add(cssObject);

            // ==========================================
            // ★ 조절 컨트롤러 (GUI) 생성 ★
            // ==========================================
            const gui = new GUI();
            const folder = gui.addFolder('화면 위치/회전 조절');
            
            const params = {
                px: cssObject.position.x,
                py: cssObject.position.y,
                pz: cssObject.position.z,
                rx: cssObject.rotation.x,
                ry: cssObject.rotation.y,
                rz: cssObject.rotation.z,
                scale: 0.001,
                print: () => {
                    console.log("=== 이 값을 복사해서 쓰세요 ===");
                    console.log(`pos: ${cssObject.position.x.toFixed(4)}, ${cssObject.position.y.toFixed(4)}, ${cssObject.position.z.toFixed(4)}`);
                    console.log(`rot: ${cssObject.rotation.x.toFixed(4)}, ${cssObject.rotation.y.toFixed(4)}, ${cssObject.rotation.z.toFixed(4)}`);
                    console.log(`scale: ${cssObject.scale.x}`);
                    alert("F12 콘솔창에 값이 출력되었습니다!");
                }
            };

            // 위치 조절
            folder.add(cssObject.position, 'x', -5, 5).name('위치 X').step(0.01).listen();
            folder.add(cssObject.position, 'y', -5, 5).name('위치 Y').step(0.01).listen();
            folder.add(cssObject.position, 'z', -5, 5).name('위치 Z').step(0.01).listen();

            // 회전 조절 (슬라이더 돌려서 맞추세요!)
            folder.add(cssObject.rotation, 'x', -Math.PI*2, Math.PI*2).name('회전 X').step(0.1).listen();
            folder.add(cssObject.rotation, 'y', -Math.PI*2, Math.PI*2).name('회전 Y').step(0.1).listen();
            folder.add(cssObject.rotation, 'z', -Math.PI*2, Math.PI*2).name('회전 Z').step(0.1).listen();
            
            // 크기 조절
            folder.add(params, 'scale', 0.0001, 0.01).name('크기').step(0.0001).onChange(v => {
                cssObject.scale.set(v, v, v);
            });

            folder.add(params, 'print').name('★ 값 콘솔 출력');
            folder.open();
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            webglRenderer.render(scene, camera);
            cssRenderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            webglRenderer.setSize(window.innerWidth, window.innerHeight);
            cssRenderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>3D Screen Calibrator</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #333; }
        #container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #guide {
            position: absolute; top: 10px; left: 10px; 
            color: yellow; font-family: sans-serif; font-weight: bold; font-size: 14px;
            background: rgba(0,0,0,0.8); padding: 15px; z-index: 100; pointer-events: none;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div id="guide">
        1. 우측 상단 컨트롤러를 조절하세요.<br>
        2. [Rotation]을 돌려 글씨가 똑바로 보이게 하세요.<br>
        3. [Scale]로 모니터 크기에 딱 맞추세요.<br>
        4. [Position]으로 위치를 잡으세요.<br>
        5. 완료되면 맨 아래 <strong>[값 콘솔 출력]</strong> 버튼 클릭!
    </div>
    <div id="container"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "lil-gui": "https://unpkg.com/three@0.160.0/examples/jsm/libs/lil-gui.module.min.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';
        import { GUI } from 'lil-gui';

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x333333);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 5000);
        camera.position.set(0, 2, 5);

        const container = document.getElementById('container');

        // WebGL
        const webglRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        webglRenderer.setSize(window.innerWidth, window.innerHeight);
        webglRenderer.domElement.style.position = 'absolute';
        webglRenderer.domElement.style.zIndex = 0; 
        container.appendChild(webglRenderer.domElement);

        // CSS3D
        const cssRenderer = new CSS3DRenderer();
        cssRenderer.setSize(window.innerWidth, window.innerHeight);
        cssRenderer.domElement.style.position = 'absolute';
        cssRenderer.domElement.style.zIndex = 1; 
        cssRenderer.domElement.style.pointerEvents = 'none'; // 조절 중 클릭 방지
        container.appendChild(cssRenderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(5, 10, 5);
        scene.add(dirLight);

        const controls = new OrbitControls(camera, webglRenderer.domElement); 
        controls.enableDamping = true;

        const loader = new GLTFLoader();
        
        loader.load('room.glb', (gltf) => {
            const model = gltf.scene;
            scene.add(model);
            
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            model.position.sub(center); 

            const screenMesh = model.getObjectByName('imacscreen');
            
            if (screenMesh) {
                // 카메라 이동
                const screenPos = new THREE.Vector3();
                screenMesh.getWorldPosition(screenPos);
                controls.target.copy(screenPos);
                camera.position.set(0, 1.5, 3.5);
                camera.lookAt(screenPos);

                addWebScreenWithGUI(screenMesh);
            } else {
                alert("'imacscreen' 찾기 실패!");
            }
        });

        function addWebScreenWithGUI(mesh) {
            const width = 2000;  
            const height = 1400; 

            const div = document.createElement('div');
            div.style.width = width + 'px'; 
            div.style.height = height + 'px'; 
            div.style.backgroundColor = 'rgba(255, 0, 0, 0.3)'; // 반투명 빨강 (위치 확인용)
            div.style.border = '10px solid yellow'; // 테두리 (사이즈 확인용)
            div.style.boxSizing = 'border-box';

            const iframe = document.createElement('iframe');
            iframe.src = 'auction.html';
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            div.appendChild(iframe);

            const cssObject = new CSS3DObject(div);
            
            // 초기값: 모델 위치 복사
            const worldPos = new THREE.Vector3();
            const worldQuat = new THREE.Quaternion();
            const worldScale = new THREE.Vector3();
            mesh.getWorldPosition(worldPos);
            mesh.getWorldQuaternion(worldQuat);
            mesh.getWorldScale(worldScale);

            cssObject.position.copy(worldPos);
            cssObject.quaternion.copy(worldQuat);
            cssObject.scale.set(0.0005, 0.0005, 0.0005); // 아주 작게 시작

            scene.add(cssObject);

            // ==========================================
            // ★ 컨트롤러 설정 ★
            // ==========================================
            const gui = new GUI({ width: 300 });
            
            // 1. 회전 (Rotation)
            const folderRot = gui.addFolder('1. 회전 (글씨 바로잡기)');
            folderRot.add(cssObject.rotation, 'x', -6.28, 6.28).step(0.1).name('Rotate X (위아래)');
            folderRot.add(cssObject.rotation, 'y', -6.28, 6.28).step(0.1).name('Rotate Y (좌우)');
            folderRot.add(cssObject.rotation, 'z', -6.28, 6.28).step(0.1).name('Rotate Z (기울기)');
            folderRot.open();

            // 2. 크기 (Scale)
            const folderScale = gui.addFolder('2. 크기 (모니터 맞추기)');
            const scaleParam = { val: 0.0005 };
            folderScale.add(scaleParam, 'val', 0.0001, 0.003).step(0.00001).name('Scale').onChange(v => {
                cssObject.scale.set(v, v, v);
            });
            folderScale.open();

            // 3. 위치 (Position)
            const folderPos = gui.addFolder('3. 위치 미세조정');
            folderPos.add(cssObject.position, 'x', -2, 2).step(0.01).name('Pos X');
            folderPos.add(cssObject.position, 'y', -2, 2).step(0.01).name('Pos Y');
            folderPos.add(cssObject.position, 'z', -2, 2).step(0.01).name('Pos Z');
            folderPos.open();

            // 4. 출력 버튼
            const params = {
                print: () => {
                    const log = `
=========================================
★ 이 코드를 복사해서 저에게 주세요! ★
position: ${cssObject.position.x.toFixed(5)}, ${cssObject.position.y.toFixed(5)}, ${cssObject.position.z.toFixed(5)}
rotation: ${cssObject.rotation.x.toFixed(5)}, ${cssObject.rotation.y.toFixed(5)}, ${cssObject.rotation.z.toFixed(5)}
scale: ${cssObject.scale.x.toFixed(6)}
=========================================`;
                    console.log(log);
                    alert("F12(개발자도구) -> Console 탭을 확인하세요!\n거기에 나온 숫자를 복사해주세요.");
                }
            };
            gui.add(params, 'print').name('★ 값 확인 (Click) ★');
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            webglRenderer.render(scene, camera);
            cssRenderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            webglRenderer.setSize(window.innerWidth, window.innerHeight);
            cssRenderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
